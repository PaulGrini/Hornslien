# Apply the Count SNPs method to Col Tsu crosses.

This document explains the generation of Col/Tsu SNP counts.
The method was previously applied to 12 genes in Col Ler crosses.
We modified the scripts to use either (1) Col Ler or (2) Col Tsu.
The choice of cross is indicated by a parameter that could be extended to incorporate other crosses.

## Step 1. Extract 10bp before & after each SNP. 
Input a delta file output by MUMmer nucmer showing Col/Tsu alignments.
Run a script that runs the MUMmmer show-snps program. 
The program requires the delta file and the two FASTA files referenced therein.
The script assigns a SNP ID to each variant.
The parameter 3 indicates Col/Tsu; 
for any value other than 3, the script defaults to Col/Ler.
```
$ show-snps -H -C -T -x 10 Col_Ler.delta | ../scripts/parse_SNPs.sh 1 > parsed_SNPs.Col_Ler.txt
$ show-snps -H -C -T -x 10 Col_Tsu.delta | ../scripts/parse_SNPs.sh 3 > parsed_SNPs.Col_Tsu.txt
```
The outputs look like this:
```
AT1G01530 COL AT1G01530.SNP1 118 G TTCAAAAAAGGCAGTGAACTT AAGTTCACTGCCTTTTTTGAA
AT1G01530 TSU AT1G01530.SNP1 118 C TTCAAAAAAGCCAGTGAACTT AAGTTCACTGGCTTTTTTGAA
```
## Step 2. Create scripts that search for SNPs.
The make_scripts.sh script takes as input the parsed_SNPs.*.txt files created above.
The make_scripts.sh script runs the script_SNP.sh script.
The make_scripts.sh script writes other scripts named count_SNP.*.sh, depending on the parameter.
The parameter values are 1=Col_Ler, 2=Ler_Col, 3=Col_Tsu, 4=Tsu_Col.
Here is how to run all four.
```
$ ../scripts/make_scripts.sh 1   
$ ../scripts/make_scripts.sh 2   
$ ../scripts/make_scripts.sh 3   
$ ../scripts/make_scripts.sh 4   
```
## Step 3. Use grep to count reads matching SNPs.
The scripts generated above were run on Abel (because large input files are required).
The scripts take '*.seq' files as input.
These input files consist of bare read sequences.
The *.seq files consisted of just nucleotides, untrimmed, 150bp per line.
These were created on Abel by extracting every 2nd line of 4 from the *.fastq files. 

For example, we ran the count_SNP.Col_x_Tsu.sh in a directory with the following files.

* Col_x_Tsu_BR1_R1.seq
* Col_x_Tsu_BR1_R2.seq
* Col_x_Tsu_BR2_R1.seq
* Col_x_Tsu_BR2_R2.seq
* Col_x_Tsu_BR3_R1.seq
* Col_x_Tsu_BR3_R2.seq

And we ran the count_SNP.Tsu_x_Col.sh in a directory with these files.

* Tsu_x_Col_BR1_R1.seq
* Tsu_x_Col_BR1_R2.seq
* Tsu_x_Col_BR3_R1.seq
* Tsu_x_Col_BR3_R2.seq
* Tsu_x_Col_BR4_R1.seq
* Tsu_x_Col_BR4_R2.seq

The output files count_SNP.Col_x_Tsu.log (and count_SNP.Tsu_x_Col.log) 
were downloaded for subsequent processing, shown below.

## Step 4. Convert the SNP count logs to csv files.
The inputs to this step are the log files generated by the previous step.
The input log files look like this
(one line of: gene, genotype, SNP ID, SNP position, SNP nucleotide, surrounding bases, strand, read;
followed by one line per replicate of: filename, SNP count):
```
AT1G02580,COL,AT1G02580.SNP3,334,T,ATTATGCTCTTGAAGAAGATG,fwd,R2
Col_x_Tsu_BR1_R2.seq:94
Col_x_Tsu_BR2_R2.seq:187
Col_x_Tsu_BR3_R2.seq:172
```
The script was run like this.
The script parameters 3 and 4 indicate Col_Tsu and Tsu_Col respectively.
```
$ ../scripts/log_to_csv.sh 3
$ ../scripts/log_to_csv.sh 4
```
The script output is in csv format.
The output accumulates all SNP counts for one SNP on one line.
The column order is: ID, 
Col fwd R1 reps 1 2 3, Col fwd R2 reps 1 2 3, Col rev R1 reps 1 2 3, Col rev R2 reps 1 2 3,
Tsu fwd R1 reps 1 2 3, Tsu fwd R2 reps 1 2 3, Tsu rev R1 reps 1 2 3, Tsu rev R2 reps 1 2 3.
In the output csv files, Col comes before other, whether Ler or Tsu.
Each output line looks like this.
```
AT1G02580.SNP3,0,0,0,94,187,172,115,208,160,0,0,0,0,0,0,86,82,82,75,67,107,0,0,0
```

## Step 5. Collapse SNP counts into one per set of counts per gene.
Input read counts per SNP and output read counts per gene.
The algorithm selects one SNP that best represents each gene.
The algorithm is not perfect; it selects the SNP having the highest count in any category 
e.g. the SNP whose Col-fwd-R1-rep2 count exceeds that of any count for any SNP for this gene. 
Then, transform the 24 counts at one SNP into six counts for one gene.
Output 6 numbers per gene: number of reads assigned to the materinal or paternal genotype in each of 3 replicates.

The script was run like this using 3=Col_x_Tsu and 4=Tsu_x_Col.
```
$ from_SNP_to_read_counts.sh 3
$ from_SNP_to_read_counts.sh 4
```
The from_SNP_to_read_counts.sh script invokes the from_SNP_to_read_counts.pl script. 
The script converted the csv files to the three_reps_per_gene format used for Informative Reads. 
The results are in files named SNP.*.three_reps_per_gene (where * is Col_x_Tsu or Tsu_x_Col). 
These outputs are designed for comparison to outputs of collate_three_reps_per_gene.sh for IR. 
The from_SNP_to_read_counts.log file has the breakdown of read counts.

The output in SNP.Col_x_Tsu.three_reps_per_gene looks like this.
In these files, maternal values have been cut in half. 
In these files, maternal comes before paternal. 
```
AT1G02580 271 274 261 205 380 229
```

## Step 6. Recreate equivalent files from Informative Reads pipeline.
Now we have the "three_reps_per_gene" files for SNP counts.
For comparison, we need the "three_reps_per_gene" files for IR counts.
Unfortunately, those were considered intermediate files and were not saved in the repo.
We will recreate them from stats files by removing all the stats.
This script inputs *.three_reps_per_gene.filtered.final.csv from the repo.
This script outputs IR *.three_reps_per_gene csv files.
```
../scripts/get_IR_three_reps_per_gene.sh 3
../scripts/get_IR_three_reps_per_gene.sh 4
```

## STEP 7. Generate statistics.
Look for correlation between the SNP counts and the IR counts.

Run the comparative_12gene_counts.sh script on SNP and IR data.
The script runs on these input files:

* IR.Col_x_Tsu.three_reps_per_gene
* IR.Tsu_x_Col.three_reps_per_gene
* SNP.Col_x_Tsu.three_reps_per_gene
* SNP.Tsu_x_Col.three_reps_per_gene

The script generates these intermediate files:

* IR.Col_x_Tsu.three_reps_per_gene.de.sorted
* IR.Tsu_x_Col.three_reps_per_gene.de.sorted
* SNP.Col_x_Tsu.three_reps_per_gene.de.sorted
* SNP.Tsu_x_Col.three_reps_per_gene.de.sorted

The script generates these output files:

* IR.Col_x_Tsu.three_reps_per_gene.final.csv
* IR.Tsu_x_Col.three_reps_per_gene.final.csv
* SNP.Col_x_Tsu.three_reps_per_gene.final.csv
* SNP.Tsu_x_Col.three_reps_per_gene.final.csv

The output files are suitable for loading into Excel.
For example, we created scatter plots in IR_vs_SNP_scatter6.xlsx (not saved in GitHub).