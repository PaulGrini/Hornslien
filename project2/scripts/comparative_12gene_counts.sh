#!/bin/sh

# Input:
#
# Generated by from_SNP_to_read_counts.sh using 12 genes... 
# SNP.Col_x_Ler.three_reps_per_gene
# SNP.Ler_x_Col.three_reps_per_gene
#
# Genated during the IR pipeline, but filtered for the 12 genes...
# IR.Col_x_Ler.three_reps_per_gene
# IR.Ler_x_Col.three_reps_per_gene
#
# Example data (gene mat/2 mat/2 mat/2 pat pat pat):
# AT1G55560.1 838 417 1056 2846 2669 3556
#
# Output:
# 
# Limma stats: 
#    gene mat/2 mat/2 mat/2 pat pat pat \
#    gene_num log_FC avg_log_expr t_statistic P_value adjusted_P LogOddsDiffExpr FoldChange

if [[ $# -eq 0 ]] ; then
    echo "ERROR! First argument is required"
    exit 1
fi
DATASET="Undefined"
PARAM="0"
if [ "$1" -eq "1" ]; then
    DATASET="Col_x_Ler"
elif [ "$1" -eq "2" ]; then
    DATASET="Ler_x_Col"
elif [ "$1" -eq "3" ]; then
    DATASET="Col_x_Tsu"
elif [ "$1" -eq "4" ]; then
    DATASET="Tsu_x_Col"
else
    echo "ERROR! First arument must be in {1,2,3,4}"
    exit 2
fi

date
pwd

if [[ -z "${SCRIPTDIR}" ]]; then
    echo "ERROR! Please set the SCRIPTDIR environment variable to the home of limma.foldchange.r"
    exit 3
else
    export SCRIPTDIR="${SCRIPTDIR}"
    echo SCRIPTDIR ${SCRIPTDIR}
    ls -l ${SCRIPTDIR}/limma.foldchange.r
    if [[ ! -f ${SCRIPTDIR}/limma.foldchange.r ]] ; then
	echo "ERROR! R scrdipt not found in SCRIPTDIR"
	exit 4
    fi
fi

echo "Get foldchange on SNP $DATASET"
Rscript ${SCRIPTDIR}/limma.foldchange.r SNP.${DATASET}.three_reps_per_gene
echo "Get foldchange on IR $DATASET"
Rscript ${SCRIPTDIR}/limma.foldchange.r IR.${DATASET}.three_reps_per_gene

for X in $(ls *.${DATASET}.three_reps_per_gene)
do
    cat ${X} | tr ' ' ',' > tmp.${X}.csv
    cat ${X}.de | tr -d '"' | sort -t"," -k1,1n | awk '{if (C++ >= 1) print $0;}' > ${X}.de.sorted
    paste tmp.${X}.csv ${X}.de.sorted | tr '\t' ',' > ${X}.final.csv
    rm tmp.${X}.csv
    rm ${X}.de
done

ls -l
echo DONE
